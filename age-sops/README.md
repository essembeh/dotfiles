# Age

> Project homepage: https://github.com/FiloSottile/age

## Create a passphrase protected key

```sh
age-keygen | age --encrypt --passphrase --armor --output ~/.age/key.txt_encrypted
Public key: age17p7q39c54jy8w3y35h5qpc6eu027elfynsm43af7d739c379ffzqtf6k4h
Enter passphrase (leave empty to autogenerate a secure one):
Using the autogenerated passphrase "august-floor-confirm-move-garbage-trophy-elegant-unable-wrist-artist".

cat key.txt_encrypted
-----BEGIN AGE ENCRYPTED FILE-----
YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IHNjcnlwdCBMd0RDMG1VNzNOYjk5V3NV
WDRvZ2xRIDE4CjBiYStNM1BGcVR6bVdOWnpRT0w1Nmw1VVVUQitxbGlCemNtM3Zr
cWhmWTQKLS0tIHFPYk1pVGNrSElMTzVpN0xoZVhGRCtpWHJLcGlOUHE4MmFUTmlp
TEVYeHcKmPbi0bkLoXUMDj4dRk4/oLBuyPyJAyTRRKGDdfblsRgAW5/gE3ZMwrHQ
lGR35svPSKr4sUvq+ifgmRZM7ZsWuS+grcdEPZZt3+qt4LXdxjsL7chopZeWm3DP
s7OY0wVqTSnOlMvKRxu0BvNa629vsvRp+Ojc5atSSlFt6C723xPLRkbCWakCG5bZ
WpH58JKvL2iPOn97h82gjb05Eb+ndV6U8V0wjSFDXl6puP0On2oqfQVPz3gDmWOP
7Pkvyx6bpmSsyKypbukfrSXF5Jqylw8zIGlMJXSWD2ufniI=
-----END AGE ENCRYPTED FILE-----
```

## Edit a text file with vim

One line command:

```sh
age -i ~/.age/key.txt_encrypted -d file.txt.age | vipe | age -a -r "age17p7q39c54jy8w3y35h5qpc6eu027elfynsm43af7d739c379ffzqtf6k4h" -o file.txt.age
```

Steps:

- `age -d` to decrypt a file
- `vipe` (from _[moreutils](https://joeyh.name/code/moreutils/)_) to edit the pipe content
- `age -e` to encrypt the content

Shell function:

```sh
age-vim () {
    if [ $# -ne 3 ]; then
        echo "Usage  : age-vim <KEY> <RECIPIENT> <FILE>"
        echo "Example: age-vim ~/.age/key.txt_encrypted age17p7q39c54jy8w3y35h5qpc6eu027elfynsm43af7d739c379ffzqtf6k4h file.txt"
    else
        age -i "$1" -d "$3" | vipe | age -a -r "$2" -o "$3"
    fi
}
```

## Load encrypted `dotenv` with `age`

```sh
eval $(age -d -i ~/.age/key.txt_encrypted .env.age)

# optional: update prompt
PS1="(ðŸ”“age) $PS1"
```

> See https://github.com/essembeh/essembeh-tools#age-source

# Sops

> Project homepage: https://github.com/mozilla/sops

## Edit files

```sh
# encrypt an existing file
sops -e -i --age age17p7q39c54jy8w3y35h5qpc6eu027elfynsm43af7d739c379ffzqtf6k4h test.env

# or read recipients from env
export SOPS_AGE_RECIPIENTS=age17p7q39c54jy8w3y35h5qpc6eu027elfynsm43af7d739c379ffzqtf6k4h
sops -e -i test.env

# edit an encrypted file
export SOPS_AGE_KEY=$(age -d ~/.age/key.txt_encrypted)
sops test.env
```

## Load encrypted `dotenv` with `sops`

```sh
# unlock key
export SOPS_AGE_KEY=$(age -d ~/.age/key.txt_encrypted)

# span a new shell with the env
sops exec-env test.env zsh

# optional: update prompt
PS1="(ðŸ”“sops) $PS1"
```

## Use encrypted kubeconfig

```sh
# decrypt age key
export SOPS_AGE_KEY=$(age -d ~/.age/key.txt_encrypted)

# use encrypted kubeconfig
sops exec-file ~/path/to/encrypted/kubeconfig.yaml "KUBECONFIG={} kubectl get pods"

# or spawn a shell with KUBECONFIG
sops exec-file --no-fifo ~/path/to/encrypted/kubeconfig.yaml "KUBECONFIG={} zsh"

# optional: update prompt
PS1="(ðŸ”“sops) $PS1"
```

> `--no-fifo` is needed if the process (`zsh` here) reads the config files multiple times (like `k9s`).
